---
title: "brouillon_app_refuge"
author: "Thibault FUCHEZ"
date: "15/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(httr)
library(jsonlite)
```

## Première requète

```{r}
url_base = "https://www.refugerestrooms.org/api"
url_byloc = "/v1/restrooms/by_location"
url_bydate = "/v1/restrooms/by_date"
url_bysearch= "/v1/restrooms/search"
url_all="/v1/restrooms"
```

```{r}
urlLoc = paste0(url_base, url_byloc)
urlAll = paste0(url_base, url_all)
```

```{r}
source("funLib.r")

alldataReq <- function(pagemax){
  dfA <- data.frame()
  for (i in 1:pagemax){
    query <- list(per_page=100, page=i)
    dfB <- req_to_df("https://www.refugerestrooms.org/api/v1/restrooms",
                     query = query)
    dfA <- rbind(dfA, dfB)}
  return(dfA)
}

res = alldataReq(488)
```


```{r}
query <- list(lng="0.689797", lat="47.390185")
resp <- GET(urlLoc, query = query)
```

```{r}
resp
```

```{r}
headers(resp)
```

```{r}
http_error(resp)
```

```{r}
http_type(resp)
```


```{r}
# Shows raw data which is not structured and readable
jsonRespText<-content(resp,as="text") 
```

```{r}
# Structurised data in form of R vectors and lists
jsonRespParsed<-content(resp,as="parsed") 
```

```{r}
json_cont <- fromJSON(jsonRespText)
```

## Fonctions

```{r}
url_base = "https://www.refugerestrooms.org/api"
url_byloc = "/v1/restrooms/by_location"
url_bydate = "/v1/restrooms/by_date"
url_bysearch= "/v1/restrooms/search"
```

```{r}
urlLoc = paste0(url_base, url_byloc)
```

```{r}
req_to_df <- function(url, query){
  resp <- GET(urlLoc, query = query)
  jsonRespText <- content(resp,as="text")
  json_cont <- fromJSON(jsonRespText)
  return(json_cont)
}
```

```{r}
query <- list(lng="0.689797", lat="47.390185")
df2 <- req_to_df(urlLoc, query_Londres)
```

```{r}
df_transfo <- function(df){
  df %>% select(c(name, street, city, state, accessible, unisex, directions, comment))
} 
```

```{r}
df2 <- df_transfo(df)
```

```{r}
resp <- get
```

## Statistiques avec le Rdata (full df)

```{r}
plop %>% group_by(country) %>% ggplot() +
  aes(x = fct_lump(fct_rev(fct_infreq(country)),10)) +
  geom_bar()+coord_flip()
```

```{r}
plop2 <- plop %>% filter(country == "FR")
```


